<!DOCTYPE html>
<html lang="en">

<meta charset="UTF-8">
<title>Magic Symon 2</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Suzerain (Rizia Edition) Save Editor</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="row">
        <div class="mb-3">
            <label for="formFile" class="form-label">Upload save file</label>
            <input class="form-control" type="file" id="json-file-input" accept=".json">
        </div>
    </div>

    <div class="card"></div>

    <form novalidate>
        <div class="accordion row" id="accordionExample">
            <div class="col-sm-4">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            Financial
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            <div class="card card-body col-sm">
                                <div>
                                    <div class="mb-3">
                                        <label for="new-authority" class="form-label">New Authority</label>
                                        <div class="input-group has-validation">
                                            <input type="text" class="form-control" id="new-authority"
                                                aria-describedby="inputGroupPrepend3 new-authorityFeedback" required
                                                placeholder="Your new authority">
                                            <div id="new-authorityFeedback" class="invalid-feedback">
                                                Please enter a number.
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <div class="mb-3">
                                            <label for="new-budget" class="form-label">New Budget</label>
                                            <div class="input-group has-validation">
                                                <input type="text" class="form-control" id="new-budget"
                                                    aria-describedby="inputGroupPrepend3 new-budgetFeedback" required
                                                    placeholder="Your new budget">
                                                <div id="new-budgetFeedback" class="invalid-feedback">
                                                    Please enter a number.
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <div class="mb-3">
                                            <label for="new-energy" class="form-label">New Energy</label>
                                            <div class="input-group has-validation">
                                                <input type="text" class="form-control" id="new-energy"
                                                    aria-describedby="inputGroupPrepend3 new-energyFeedback" required
                                                    placeholder="Your new energy">
                                                <div id="new-energyFeedback" class="invalid-feedback">
                                                    Please enter a number.
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            Financial (Per Turn)
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            <div class="card card-body col-sm">
                                <div>
                                    <div class="mb-3">
                                        <label for="new-authorityPT" class="form-label">New Authority
                                            <i class="fa fa-question-circle" aria-hidden="true" data-toggle="tooltip"
                                                data-placement="bottom" title="Base Toros Modifier"></i>
                                        </label>
                                        <div class="input-group has-validation">
                                            <input type="text" class="form-control" id="new-authorityPT"
                                                aria-describedby="inputGroupPrepend3 new-authorityFeedback" required
                                                placeholder="Your new authority PT">
                                            <div id="new-authorityFeedback" class="invalid-feedback">
                                                Please enter a number.
                                            </div>

                                        </div>
                                    </div>

                                    <div>
                                        <div class="mb-3">
                                            <label for="new-budgetPT" class="form-label">New Budget
                                                <i class="fa fa-question-circle" aria-hidden="true"
                                                    data-toggle="tooltip" data-placement="bottom"
                                                    title="Base Income Tax Modifier"></i>
                                            </label>
                                            <div class="input-group has-validation">
                                                <input type="text" class="form-control" id="new-budgetPT"
                                                    aria-describedby="inputGroupPrepend3 new-budgetFeedback" required
                                                    placeholder="Your new budget PT">
                                                <div id="new-budgetFeedback" class="invalid-feedback">
                                                    Please enter a number.
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <div class="mb-3">
                                            <label for="new-energyPT" class="form-label">New
                                                Energy
                                                <i class="fa fa-question-circle" aria-hidden="true"
                                                    data-toggle="tooltip" data-placement="bottom"
                                                    title="Base Hydro Electric Dam Modifier"></i>
                                            </label>
                                            <div class="input-group has-validation">
                                                <input type="text" class="form-control" id="new-energyPT"
                                                    aria-describedby="inputGroupPrepend3 new-energyFeedback" required
                                                    placeholder="Your new energy PT">
                                                <div id="new-energyFeedback" class="invalid-feedback">
                                                    Please enter a number.
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm">
            <button id="download-button" type="submit" class="btn btn-outline-success" disabled>Download new
                savefile</button>
        </div>
    </form>

    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });

        document.addEventListener("DOMContentLoaded", function () {
            const jsonFileInput = document.getElementById("json-file-input");
            const jsonDisplay = document.getElementById("json-display");
            const downloadButton = document.getElementById("download-button");

            let modifiedData = null;
            let vars = null;
            let startingbudgetIndex = null;
            let startingBudgetIndex = null;
            let variablesString = null;

            jsonFileInput.addEventListener("change", function (event) {
                const selectedFile = event.target.files[0];

                if (selectedFile) {
                    const reader = new FileReader();

                    reader.onload = function () {
                        const fileContent = reader.result;

                        try {
                            const jsonData = JSON.parse(fileContent);

                            // Extract and parse the "variables" property
                            variablesString = jsonData.variables;
                            const variables = {};

                            // Remove the "variables" property from the parsed JSON
                            jsonData.variables;
                            modifiedData = jsonData;

                            //Regex match on the relevant properties
                            var pattern = /\[\"RiziaDLC\.Resources_Authority\"]=(\d+)/;
                            var match = pattern.exec(variablesString);

                            var pattern2 = /\[\"RiziaDLC\.Resources_Budget\"]=(\d+)/;
                            var match2 = pattern2.exec(variablesString);

                            var pattern3 = /\[\"RiziaDLC\.Resources_Energy\"]=(\d+)/;
                            var match3 = pattern3.exec(variablesString);

                            var pattern4 = /\[\"RiziaDLC\.Authority_Modifier_BaseMonarchRomus\"]=(\d+)/;
                            var match4 = pattern4.exec(variablesString);

                            var pattern5 = /\[\"RiziaDLC\.Budget_Modifier_IncomeTax\"]=(\d+)/;
                            var match5 = pattern5.exec(variablesString);

                            var pattern6 = /\[\"RiziaDLC\.Energy_Modifier_ZpanaHydroelectricDam\"]=(\d+)/;
                            var match6 = pattern6.exec(variablesString);



                            //Show current values
                            document.getElementById("new-authority").value = match[1];
                            document.getElementById("new-budget").value = match2[1];
                            document.getElementById("new-energy").value = match3[1];

                            document.getElementById("new-authorityPT").value = match4[1];
                            document.getElementById("new-budgetPT").value = match5[1];
                            document.getElementById("new-energyPT").value = match6[1];

                            downloadButton.style.display = "block";
                        } catch (error) {
                            console.error("Error parsing JSON:", error);
                            jsonDisplay.textContent = "Error parsing JSON.";
                        }
                    };

                    reader.readAsText(selectedFile);
                } else {
                    jsonDisplay.textContent = "No file selected.";
                }
            });

            downloadButton.addEventListener("click", function () {
                const newAuthority = document.getElementById("new-authority").value;
                const newbudget = document.getElementById("new-budget").value;
                const newEnergy = document.getElementById("new-energy").value;

                const newAuthorityPT = document.getElementById("new-authorityPT").value;
                const newbudgetPT = document.getElementById("new-budgetPT").value;
                const newEnergyPT = document.getElementById("new-energyPT").value;


                // Regex match (again,who wrote this lousy junk?)
                var pattern = /\[\"RiziaDLC\.Resources_Authority\"]=(\d+)/;
                var pattern2 = /\[\"RiziaDLC\.Resources_Budget\"]=(\d+)/;
                var pattern3 = /\[\"RiziaDLC\.Resources_Energy\"]=(\d+)/;

                var pattern4 = /\[\"RiziaDLC\.Authority_Modifier_BaseMonarchRomus\"]=(\d+)/;
                var pattern5 = /\[\"RiziaDLC\.Budget_Modifier_IncomeTax\"]=(\d+)/;
                var pattern6 = /\[\"RiziaDLC\.Energy_Modifier_ZpanaHydroelectricDam\"]=(\d+)/;


                // Replace the matched substring with the new number
                var modifiedString = variablesString.replace(pattern, "[\"RiziaDLC.Resources_Authority\"]=" + newAuthority);
                var modifiedString = modifiedString.replace(pattern2, "[\"RiziaDLC.Resources_Budget\"]=" + newbudget);
                var modifiedString = modifiedString.replace(pattern3, "[\"RiziaDLC.Resources_Energy\"]=" + newEnergy);

                var modifiedString = modifiedString.replace(pattern4, "[\"RiziaDLC.Authority_Modifier_BaseMonarchRomus\"]=" + newAuthorityPT);
                var modifiedString = modifiedString.replace(pattern5, "[\"RiziaDLC.Budget_Modifier_IncomeTax\"]=" + newbudgetPT);
                var modifiedString = modifiedString.replace(pattern6, "[\"RiziaDLC.Energy_Modifier_ZpanaHydroelectricDam\"]=" + newEnergyPT);

                modifiedData.variables = modifiedString;
                const jsonData = JSON.stringify(modifiedData);

                //Download stuffs
                const blob = new Blob([jsonData], { type: "application/json" });
                const url = URL.createObjectURL(blob);

                // Create a download link and trigger a click event
                const a = document.createElement("a");
                a.href = url;
                a.download = "newSave.json";
                document.body.appendChild(a);
                a.click();

                // Clean up the temporary URL and link
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
            });


            document.getElementById("new-authority").addEventListener("keyup", onFormUpdate);
            document.getElementById("new-budget").addEventListener("keyup", onFormUpdate);
            document.getElementById("new-energy").addEventListener("keyup", onFormUpdate);

            document.getElementById("new-authorityPT").addEventListener("keyup", onFormUpdate);
            document.getElementById("new-budgetPT").addEventListener("keyup", onFormUpdate);
            document.getElementById("new-energyPT").addEventListener("keyup", onFormUpdate);
        });

        document.getElementById("json-file-input").addEventListener("change", function () {
            document.getElementById("download-button").removeAttribute("disabled");

        });

        function onFormUpdate() {

            const authority = document.getElementById("new-authority").value;
            const budget = document.getElementById("new-budget").value;
            const energy = document.getElementById("new-energy").value;

            const authorityPT = document.getElementById("new-authorityPT").value;
            const budgetPT = document.getElementById("new-budgetPT").value;
            const energyPT = document.getElementById("new-energyPT").value;


            if (authority > 0) {
                $(`#new-authority`).attr('class', 'form-control valid');
            } else {
                $(`#new-authority`).attr('class', 'form-control is-invalid');
                document.getElementById("download-button").setAttribute("disabled", "");
            }

            if (budget > 0) {
                $(`#new-budget`).attr('class', 'form-control valid');
            } else {
                $(`#new-budget`).attr('class', 'form-control is-invalid');
                document.getElementById("download-button").setAttribute("disabled", "");
            }

            if (energy > 0) {
                $(`#new-energy`).attr('class', 'form-control valid');
            } else {
                $(`#new-energy`).attr('class', 'form-control is-invalid');
                document.getElementById("download-button").setAttribute("disabled", "");
            }

            if (authorityPT > 0) {
                $(`#new-authorityPT`).attr('class', 'form-control valid');
            } else {
                $(`#new-authorityPT`).attr('class', 'form-control is-invalid');
                document.getElementById("download-button").setAttribute("disabled", "");
            }

            if (budgetPT > 0) {
                $(`#new-budgetPT`).attr('class', 'form-control valid');
            } else {
                $(`#new-budgetPT`).attr('class', 'form-control is-invalid');
                document.getElementById("download-button").setAttribute("disabled", "");
            }

            if (energyPT > 0) {
                $(`#new-energyPT`).attr('class', 'form-control valid');
            } else {
                $(`#new-energyPT`).attr('class', 'form-control is-invalid');
                document.getElementById("download-button").setAttribute("disabled", "");
            }

            if ((authority > 0) && (budget > 0) && (energy > 0) && (authorityPT > 0) && (budgetPT > 0) && (energyPT > 0)) {
                document.getElementById("download-button").removeAttribute("disabled");
            }
        }
    </script>
</body>

</html>